Домашнее задание №5

Срок выполнения - 16 декабря 2017 (РК2)

Тема: кодогенерация хттп-методов и валидация

----

Кодогенерация очень широко используется в го и надо уметь пользоваться этим инструментм.

В этом задании вам необходимо будет написать кодогенератор, который ищем методы структуры, помеченный спец меткой и генерирует для них следующий код:
* http-обёртки для этих методов
* проверку авторизации
* проверки метода (GET/POST)
* валидацию параметров
* заполнение структуры с параметрами метода
* обработку неизвестных ошибок

Т.е. вы пишите программу (в папке `handler_gen`) потом запускаете её, передавая в качестве параметров путь до файла для которого надо сгенерировать код, и путь до файла, в который записать результат. Запуск будет выглядеть примерно так: `go build ./handler_gen/ && ./handler_gen site/api.go site/api_handlers.go`

Сразу предупреждаю! Хардкод запрещён! Кто будет руками писать что-то в методы - будет снижение баллов. Все данные - имена полей, доступные значения, граничные значения - всё брать из самой струкруты, struct tags `apivalidator` и кода который мы парсим. Ваш кодогенератор должен работать универстально для любых поле и значений из тех что ему известны.

Кодогенератор уммет обрабатывать следующие типы полей структуры:
* int
* string

Нам доступны следующие метки валидатора-заполнятора `apivalidator`:
* required - поле не должно быть пустым (не должно иметь значение по-умолчанию)
* paramname - если указано - то брать из параметра с этим именем, иначе lowercase от имени
* enum - "одно из"
* default - если указано и приходит пустое значение (значение по-умолчанию) - устанавливать то что написано указано в default
* min - >= X для типа int, для строк len(str) >=
* max - <= X для типа int

Формат ошибок смотрите в тестах. Порядок следования ошибок:
* наличие метода (в ServeHTTP)
* метод (POST)
* авторизация
* параметры в порядке следования в структуре

Авторизация проверяется просто на то что в хедере пришло значение `100500`

Сгенерённый код будет иметь примерно такую цепочку
* `ServeHTTP` - принимает все методы из мультиплексора, если нашлось - вызывает `handler$methodName`, если нет - говорит 404
* `handler$methodName` - обёртка над методом структуры `$methodName` - осуществляет все проверки, выводит ошибки или результат в формате JSON
* `$methodName` - непосредственно мето структуры для которого мы генерируем код и который парсим. имеет префикс `apigen:api` за который следует json с иметем метода, типом и требованием авторизации. Его генерировать не нужно, он уже есть.

По структуре кодогенератора - надо найти все методы, для каждого метода сгенерить валидацию входящих парметров и прочие проверки в handler$methodName, для пачки методов структуры сгенерить ServeHTTP

Над ошибками кодогенератора можно сильно не заморачиваться - параметры который в него передаются будем считать гарантированно корректными.

Пример для кодогенерации смотрите в 3/3_codegen/gen - на лекции я подробно про него расказывал.

Что надо парсит в ast:
* node.Decls -> ast.FuncDecl - это метод. у него надо проверить что есть метка и начать генерить для него обёртку
* node.Decls -> ast.GenDecl -> spec.(*ast.TypeSpec) + currType.Type.(*ast.StructType) - это структура. она нужна чтобы по ней генерить валидацию для метода, который мы нашли в проедыдущем пункте

Вы можете использовать как шаблоны чтобы сгенерить сразу весь метод, так и собирать код из маленьких кусков.